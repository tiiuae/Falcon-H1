<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Fine-Tuning Guidelines - Falcon H1</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/fontawesome.min.css" rel="stylesheet">
        <link href="../css/brands.min.css" rel="stylesheet">
        <link href="../css/solid.min.css" rel="stylesheet">
        <link href="../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/mono-blue.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Falcon H1</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item">
                                <a href="../deployment/" class="nav-link">Deployment</a>
                            </li>
                            <li class="nav-item">
                                <a href="../evaluations/" class="nav-link">Evaluations</a>
                            </li>
                            <li class="nav-item">
                                <a href="./" class="nav-link active" aria-current="page">Fine-Tuning Guidelines</a>
                            </li>
                            <li class="nav-item">
                                <a href="../post_training_details/" class="nav-link">Our settings</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../evaluations/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../post_training_details/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#fine-tuning-guidelines" class="nav-link">Fine-Tuning Guidelines</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#initial-recommendations" class="nav-link">Initial Recommendations</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#low-rank-adaptation-lora-considerations" class="nav-link">Low-Rank Adaptation (LoRA) Considerations</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#quantization-with-qlora-training" class="nav-link">Quantization with QLoRA (training)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="fine-tuning-guidelines">Fine-Tuning Guidelines</h1>
<p>This document outlines a series of recommendations and best practices for fine-tuning models within the Falcon-H1 series. Given that Falcon-H1 is seamlessly integrated into the Hugging Face Transformers library, it is inherently compatible with the majority of the ecosystem's components. Nevertheless, it is imperative to adhere to certain fundamental principles prior to initiating fine-tuning for specific applications.</p>
<h2 id="initial-recommendations">Initial Recommendations</h2>
<ul>
<li><strong>OUMI Framework</strong>: For detailed guidance, refer to the relevant documentation section available <a href="https://github.com/oumi-ai/oumi/tree/main/configs/recipes/falcon_h1">here</a>.</li>
<li><strong>Llama-Factory framework</strong>: For detailed guidance, please refer to the official documentation of <a href="https://github.com/hiyouga/LLaMA-Factory">llama-factory</a>.</li>
<li><strong>axolotl framework</strong>: You can install <code>axolotl</code> and use one of the pre-defined configuration file <a href="https://github.com/axolotl-ai-cloud/axolotl/tree/main/examples/falcon-h1">from this folder</a> to get started.</li>
<li><strong>unsloth</strong>: Falcon-H1 is integrated into unsloth training framework. Check out the example notebook exposed <a href="https://github.com/unslothai/notebooks/pull/64">here</a> (the notebook will be merged soon into the main library) </li>
<li><strong>Hyperparameter Configuration</strong>: For insights into the hyperparameters utilized in our experimental setup, consult the <a href="../post_training_details/">Post-Training Details</a> document.</li>
</ul>
<p>Integration into other platforms, is coming soon.</p>
<h2 id="low-rank-adaptation-lora-considerations">Low-Rank Adaptation (LoRA) Considerations</h2>
<p>When configuring LoRA for Falcon-H1, it is crucial to exclude the <code>conv1d</code> and <code>out_proj</code> layers from the LoRA adaptation process. This exclusion is warranted for the following reasons:</p>
<ol>
<li>The weights of these modules are directly transferred to a custom autograd Mamba kernel, thereby bypassing the forward pass of the LoRA modules. Consequently, the base layer weights are utilized directly.</li>
<li>The weight dimensions of depth-wise convolution (characterized by <code>ngroups=input_channels</code>) are structured as <code>(out_channels, 1, kernel_size)</code>. Since this convolution does not involve channel mixing—owing to the second dimension being equal to 1—applying LoRA to this module is not advisable. As a general guideline, users are cautioned against applying LoRA to depth-wise 1D convolution layers, particularly in Mamba-based architectures.</li>
<li>Attempting to merge LoRA weights into the base model may result in complications. For further details, refer to <a href="https://github.com/tiiuae/Falcon-H1/issues/13">this issue</a>.</li>
</ol>
<h2 id="quantization-with-qlora-training">Quantization with QLoRA (training)</h2>
<p>When employing QLoRA, it is essential to ensure that the <code>out_proj</code> layer is not subjected to quantization. This is because the weights of the <code>out_proj</code> layer are directly utilized within the Mamba kernel. Below is an illustrative configuration snippet:</p>
<pre><code class="language-diff">    bnb_config = BitsAndBytesConfig(
        load_in_4bit=True,
        bnb_4bit_quant_type=&quot;nf4&quot;,
        bnb_4bit_use_double_quant=True,
        bnb_4bit_compute_dtype=torch.bfloat16,
+       llm_int8_skip_modules=[&quot;out_proj&quot;]
    )
</code></pre>
<p>Note inference should work without further tweaking or modification.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
